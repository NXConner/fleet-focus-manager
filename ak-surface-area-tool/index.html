<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Surface Area Measurement Tool</title>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="anonymous">
	<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" crossorigin="anonymous">
	<style>
		html, body { height: 100%; margin: 0; }
		#app { display: grid; grid-template-rows: auto 1fr; height: 100%; }
		.toolbar { display: grid; grid-template-columns: 1fr auto auto; gap: 8px; align-items: center; padding: 10px; border-bottom: 1px solid #ddd; }
		.toolbar input[type="text"] { padding: 8px; font-size: 14px; }
		.toolbar button { padding: 8px 10px; font-size: 14px; cursor: pointer; }
		#map { width: 100%; height: 100%; }
		.panel { position: absolute; top: 70px; right: 10px; background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); z-index: 1000; min-width: 240px; }
		.panel h3 { margin: 0 0 8px; font-size: 16px; }
		.panel .row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 14px; }
		.panel .small { color: #666; font-size: 12px; }
		.footer-note { position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 6px 8px; border: 1px solid #eee; border-radius: 4px; font-size: 12px; z-index: 900; }
	</style>
</head>
<body>
	<div id="app">
		<div class="toolbar">
			<input id="addressInput" type="text" placeholder="Search address (e.g., 337 Ayers Orchard Rd, Stuart, VA)" />
			<button id="searchBtn">Search</button>
			<button id="clearBtn">Clear Shapes</button>
		</div>
		<div id="map"></div>
	</div>

	<div class="panel" id="statsPanel">
		<h3>Selection Totals</h3>
		<div class="row"><span>Area (sq ft):</span><strong id="sqft">0</strong></div>
		<div class="row"><span>Area (sq yd):</span><strong id="sqyd">0</strong></div>
		<div class="row"><span>Area (acres):</span><strong id="acres">0</strong></div>
		<div class="row small"><span>Polygons:</span><span id="polyCount">0</span></div>
	</div>
	<div class="footer-note">Draw polygons or rectangles. Double-click to finish a shape. Edit/delete with the toolbar.</div>

	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js" crossorigin="anonymous"></script>
	<script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js" crossorigin="anonymous"></script>
	<script>
		const map = L.map('map', { zoomControl: true }).setView([36.6418, -80.2739], 13);
		const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 20,
			attribution: '&copy; OpenStreetMap contributors'
		});
				const esri = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
			maxZoom: 20,
			attribution: 'Tiles © Esri — Sources: Esri, i-Cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
		});
		esri.addTo(map);

		const drawnItems = new L.FeatureGroup();
		map.addLayer(drawnItems);

		const drawControl = new L.Control.Draw({
			edit: { featureGroup: drawnItems },
			draw: {
				polyline: false,
				circle: false,
				marker: false,
				circlemarker: false,
				polygon: { allowIntersection: false, showArea: true },
				rectangle: { showArea: true }
			}
		});
		map.addControl(drawControl);

		function updateStats() {
			let totalSqMeters = 0;
			let polygonCount = 0;
			drawnItems.eachLayer(layer => {
				if (layer instanceof L.Polygon && !(layer instanceof L.Rectangle)) {
					polygonCount += 1;
				}
				if (layer.getLatLngs) {
					const latlngs = layer.getLatLngs();
					const coords = latlngs[0].map(p => [p.lng, p.lat]);
					if (coords.length >= 3) {
						const poly = turf.polygon([[...coords, coords[0]]]);
						totalSqMeters += turf.area(poly);
					}
				}
			});
			const sqft = totalSqMeters * 10.76391041671;
			const sqyd = sqft / 9;
			const acres = sqft / 43560;
			document.getElementById('sqft').textContent = Math.round(sqft).toLocaleString();
			document.getElementById('sqyd').textContent = Math.round(sqyd).toLocaleString();
			document.getElementById('acres').textContent = acres.toFixed(4);
			document.getElementById('polyCount').textContent = polygonCount;
		}

		map.on(L.Draw.Event.CREATED, function (e) {
			drawnItems.addLayer(e.layer);
			updateStats();
		});
		map.on(L.Draw.Event.EDITED, updateStats);
		map.on(L.Draw.Event.DELETED, updateStats);

		document.getElementById('clearBtn').addEventListener('click', () => {
			drawnItems.clearLayers();
			updateStats();
		});

		async function geocode(query) {
			const url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(query);
			const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
			if (!res.ok) return null;
			const data = await res.json();
			return data && data.length ? data[0] : null;
		}

		const searchBtn = document.getElementById('searchBtn');
		const input = document.getElementById('addressInput');
		searchBtn.addEventListener('click', async () => {
			if (!input.value.trim()) return;
			searchBtn.disabled = true;
			try {
				const hit = await geocode(input.value.trim());
				if (hit) {
					const lat = parseFloat(hit.lat);
					const lon = parseFloat(hit.lon);
					map.setView([lat, lon], 19);
				} else {
					alert('Address not found');
				}
			} finally {
				searchBtn.disabled = false;
			}
		});
		input.addEventListener('keydown', (e) => { if (e.key === 'Enter') searchBtn.click(); });

		updateStats();
	</script>
</body>
</html>